remote_state {
  backend = "s3"
  config = {
    bucket         = "{{ project_name_hyphens }}-terraform-state-bucket-{{ random_suffix }}"
    key            = "${path_relative_to_include()}/terraform.tfstate"
    region         = "us-west-2"
    encrypt        = true # This is S3-side encryption, not client-side
    dynamodb_table = "{{ project_name_hyphens }}-terraform-lock-table-{{ random_suffix }}"
  }
}

generate "encryption_config" {
  path      = "encryption.tf"
  if_exists = "overwrite"
  contents  = <<EOF
# DO NOT EDIT THIS FILE MANUALLY, AND DO NOT CHECK IT IN TO SOURCE CONTROL
# This file is generated by Terragrunt.
terraform {
  encryption {
    key_provider "pbkdf2" "main_key" {
      passphrase = "${get_env("TF_STATE_ENCRYPTION_PASSPHRASE", "")}"
    }
    
    method "aes_gcm" "encrypted" {
      keys = key_provider.pbkdf2.main_key
    }
    
    state {
      method = method.aes_gcm.encrypted
      enforced = true
    }
  }
}
EOF
}
