# justfile for {{ project_name }}

setup:
    echo "Setting up dev environment for {{ project_name }}..."
    mise trust
    mise install
    mise x go -- go mod tidy

generate:
    mkdir -p internal/handler
    mise x oapi-codegen -- \
        oapi-codegen \
            -package handler \
            -generate types,server,spec \
            -o internal/handler/api.gen.go \
            api/openapi.yaml
    mise x go -- go mod tidy

lint:
    echo "Linting {{ project_name }}..."
    mise x go -- golangci-lint run --fix ./...

test:
    mise x go -- go test ./... -v

build:
    mise x go -- go build -o bin/server cmd/server/main.go

run:
    mise x go -- go run cmd/server/main.go

docker-build:
    docker build --target final -t {{ project_name }}:latest .

push:
    # Suppose we push to some ECR. The actual repository URI might be from Terraform outputs.
    echo "Pushing {{ project_name }} to ECR..."

terraform-init:
    cd terraform && terragrunt run-all init --tf-forward-stdout

terraform-plan:
    cd terraform && terragrunt run-all plan --tf-forward-stdout

deploy-infra:
    cd terraform/infrastructure && terragrunt init && terragrunt apply -auto-approve

deploy-app:
    cd terraform/dev && terragrunt run-all apply -auto-approve
